# Gallery Reader 效能優化說明

## 優化日期：2026-01-09

## 問題診斷

原本載入緩慢的原因：
1. 每次懶載入都發送 API 請求
2. 導航資訊沒有快取
3. 圖片沒有快取頭
4. 預載入數量太少
5. IntersectionObserver 提前載入距離太短

---

## 優化項目

### 1. 前端優化 (`reader.js`)

| 項目 | 修改前 | 修改後 |
|------|--------|--------|
| 初始載入策略 | 全部用佔位符 | 前 5 張直接載入 |
| 預載入數量 | 3 張 | 8 張 |
| rootMargin | 800px | 1200px |
| 預載入追蹤 | 無 | 使用 Set 避免重複 |

### 2. 後端優化 (`routes.py`)

| 項目 | 修改前 | 修改後 |
|------|--------|--------|
| 圖片快取 | 無 | `Cache-Control: max-age=86400` (1天) |
| API 快取 | 無 | `Cache-Control: max-age=300` (5分鐘) |

### 3. 服務層優化 (`service.py`)

| 項目 | 修改前 | 修改後 |
|------|--------|--------|
| 導航資訊快取 | 無 | 加入記憶體快取 |
| Gallery 根目錄快速路徑 | 無 | 直接返回，跳過掃描 |
| DEBUG 輸出 | 有 | 移除 |

### 4. 基礎讀取器優化 (`base_reader.py`)

| 項目 | 修改前 | 修改後 |
|------|--------|--------|
| 快取容量 | 50 個目錄 | 200 個目錄 |

---

## 預期效果

1. **首次載入**：前 5 張圖片立即顯示，不需等待
2. **滾動體驗**：提前 1200px 預載入 + 8 張預載入，滾動時幾乎無延遲
3. **重複訪問**：瀏覽器快取生效，圖片秒開
4. **記憶體效率**：使用 Set 追蹤預載入，避免重複請求

---

## 後續可優化項目

1. **圖片壓縮/WebP**：考慮在伺服器端生成縮圖
2. **Service Worker**：實現離線快取
3. **虛擬滾動**：對於超大圖集（1000+ 張）考慮虛擬滾動
4. **CDN**：如果部署到生產環境，考慮使用 CDN
