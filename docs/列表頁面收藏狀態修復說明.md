# 列表頁面收藏狀態顯示修復說明

## 🐛 問題描述

在列表頁面點擊收藏按鈕後,星星會變成實心 (★),但切換到「收藏」篩選頁面時,星星顯示為空心 (☆)。

## 🔍 問題原因

### 1. 後端未返回狀態資訊

在 `get_manga_list()` 和 `get_gallery_list()` 函數中,返回的漫畫/作品資訊中沒有包含 `status` 欄位,導致前端無法判斷作品的收藏狀態。

**問題代碼** (manga/service.py):
```python
manga_info = {
    'name': manga_dir.name,
    'path': formatPathForUrl(manga_dir.relative_to(self.root_path)),
    'chapters': chapters,
    'chapter_count': chapter_count,
    'cover_image': cover_image
    # ❌ 缺少 'status' 欄位
}
mangas.append(manga_info)
```

### 2. 重新載入條件錯誤

在收藏頁面取消收藏時,重新載入列表的判斷條件錯誤。

**問題代碼** (manga/index.js):
```javascript
// ❌ 錯誤：isFavorite 是點擊「前」的狀態
if (currentFilter === 'favorite' && !isFavorite) {
    setTimeout(() => loadMangas(), 300);
}
```

這個條件的意思是「當前在收藏頁面,且原本不是收藏狀態」,這永遠不會發生,因為在收藏頁面的項目一定都是收藏狀態。

## ✅ 解決方案

### 1. 後端添加狀態欄位

在返回列表資料時,為每個項目添加 `status` 欄位。

**修復代碼** (manga/service.py):
```python
# 添加狀態信息（不緩存，因為會變動）
if status_manager:
    manga_info_copy = manga_info.copy()
    manga_info_copy['status'] = status_manager.get_status('manga', manga_dir.name)
    mangas.append(manga_info_copy)
else:
    mangas.append(manga_info)
```

**關鍵點:**
- 使用 `copy()` 創建副本,避免修改緩存的資料
- `status` 不放入緩存,因為會頻繁變動
- 每次請求都動態獲取最新狀態

### 2. 修正重新載入條件

**修復代碼** (manga/index.js):
```javascript
// ✅ 正確：isFavorite 是點擊「前」的狀態
if (currentFilter === 'favorite' && isFavorite) {
    setTimeout(() => loadMangas(), 300);
}
```

**邏輯解釋:**
- `isFavorite` = true: 點擊「前」是收藏狀態
- 點擊後變成: unreviewed (未審核)
- 條件: 在收藏頁面 + 剛剛是收藏 = 需要重新載入 (因為該項目已不屬於收藏列表)

## 📁 修改的檔案

### 後端 (Python)

1. **src/modules/manga/service.py**
   - `get_manga_list()` 函數
   - 添加 `status` 欄位到返回資料

2. **src/modules/gallery/service.py**
   - `get_gallery_list()` 函數
   - 添加 `status` 欄位到返回資料

### 前端 (JavaScript)

1. **src/static/js/manga/index.js**
   - `toggleCardFavorite()` 函數
   - 修正重新載入條件: `!isFavorite` → `isFavorite`

2. **src/static/js/gallery/index.js**
   - `toggleCardFavorite()` 函數
   - 修正重新載入條件: `!isFavorite` → `isFavorite`

## 🔄 資料流程

### 正確的流程

1. **初始載入收藏頁面**:
   ```
   前端: GET /manga/api/list?status=favorite
   後端: 返回 [{name: "作品A", status: "favorite"}, ...]
   前端: 顯示實心星 ★
   ```

2. **點擊取消收藏**:
   ```
   前端: isFavorite = true (點擊前的狀態)
   前端: POST /manga/api/status/作品A {status: "unreviewed"}
   後端: 更新 status.json
   前端: 更新按鈕 ★ → ☆
   前端: 判斷需要重新載入 (因為 isFavorite === true)
   前端: 300ms 後重新載入列表
   後端: 返回 [] (該作品已不在收藏列表)
   ```

3. **在全部頁面點擊收藏**:
   ```
   前端: isFavorite = false (點擊前的狀態)
   前端: POST /manga/api/status/作品B {status: "favorite"}
   後端: 更新 status.json
   前端: 更新按鈕 ☆ → ★
   前端: 不需要重新載入 (因為 currentFilter !== 'favorite')
   ```

## 🎯 測試驗證

### 測試案例 1: 收藏頁面顯示

1. 在全部頁面收藏幾個作品
2. 點擊「⭐ 收藏」篩選按鈕
3. **預期**: 所有作品的星星都是實心 ★
4. **結果**: ✅ 正確顯示

### 測試案例 2: 收藏頁面取消收藏

1. 在收藏頁面
2. 點擊任一作品的星星
3. **預期**: 星星變空心 ☆,300ms 後作品從列表消失
4. **結果**: ✅ 正確行為

### 測試案例 3: 全部頁面收藏

1. 在全部頁面
2. 點擊未收藏作品的星星
3. **預期**: 星星變實心 ★,作品保持在列表中
4. **結果**: ✅ 正確行為

### 測試案例 4: 狀態同步

1. 在列表頁面收藏作品A
2. 進入作品A的閱讀器頁面
3. **預期**: 閱讀器頁面的收藏按鈕也是實心 ★
4. **結果**: ✅ 狀態同步

## 📊 技術細節

### 為什麼不緩存 status?

```python
# ❌ 錯誤做法：緩存包含 status 的資料
work_info = {
    'name': work_dir.name,
    'status': status_manager.get_status('gallery', work_dir.name)  # 會變動
}
self.cache[cache_key] = work_info  # 緩存後就不會更新了

# ✅ 正確做法：分離緩存和動態資料
work_info = {...}  # 不包含 status
self.cache[cache_key] = work_info  # 緩存靜態資料

work_info_copy = work_info.copy()
work_info_copy['status'] = status_manager.get_status(...)  # 動態獲取
works.append(work_info_copy)
```

### 為什麼要 setTimeout()?

```javascript
// 給用戶看到按鈕變化的視覺回饋
buttonElement.textContent = isFavorite ? '☆' : '★';

// 延遲 300ms 再重新載入,避免視覺上的突兀
setTimeout(() => loadMangas(), 300);
```

## 🎉 修復效果

- ✅ 收藏頁面正確顯示實心星
- ✅ 取消收藏後自動刷新列表
- ✅ 狀態與閱讀器頁面完全同步
- ✅ 視覺回饋流暢自然

## 更新時間

2026-01-11
