# 路由修復總結

## 🐛 問題描述

之前在閱讀器頁面請求章節數據時，API 路徑出現重複前綴的問題：
```
錯誤: GET /manga/api/manga/chapter/xxx HTTP/1.1 404
正確: GET /api/manga/chapter/xxx HTTP/1.1 200
```

## ✅ 修復內容

### reader.html 修改

1. **修復 API 端點設置**
   ```javascript
   // 之前（錯誤）
   this.apiPrefix = `/${this.category}`;
   // API 調用: ${this.apiPrefix}/api/${this.category}/chapter/...
   // 結果: /manga/api/manga/chapter/...  ❌
   
   // 之後（正確）
   this.apiChapterEndpoint = `/api/${this.category}/chapter/`;
   // API 調用: ${this.apiChapterEndpoint}${chapterPath}
   // 結果: /api/manga/chapter/...  ✅
   ```

2. **簡化 API 調用**
   ```javascript
   // 之前
   fetch(`${this.apiPrefix}/api/${this.category}/chapter/${encodeURIComponent(this.chapterPath)}`)
   
   // 之後  
   fetch(`${this.apiChapterEndpoint}${encodeURIComponent(this.chapterPath)}`)
   ```

## 📋 當前路由結構

### 後端路由 (Flask)

```python
# 頁面路由
/                          -> 重定向到 /manga
/manga                     -> 漫畫列表頁面
/pixiv                     -> PIXIV列表頁面
/manga/reader/<path>       -> 漫畫閱讀器
/pixiv/reader/<path>       -> PIXIV閱讀器

# API 路由
/api/config                -> 獲取配置
/api/manga/list            -> 獲取漫畫列表
/api/pixiv/list            -> 獲取PIXIV列表
/api/manga/<path>          -> 獲取漫畫詳情
/api/pixiv/<path>          -> 獲取PIXIV詳情
/api/manga/chapter/<path>  -> 獲取漫畫章節圖片
/api/pixiv/chapter/<path>  -> 獲取PIXIV章節圖片

# 資源路由
/manga/image/<path>        -> 提供漫畫圖片
/pixiv/image/<path>        -> 提供PIXIV圖片
```

### 前端路由解析

**在 index.html 中：**
```javascript
const currentCategory = '{{ category }}';  // 從後端模板獲取
const apiEndpoint = `/api/${currentCategory}/list`;
const imagePrefix = `/${currentCategory}/image/`;
const readerPrefix = `/${currentCategory}/reader/`;
```

**在 reader.html 中：**
```javascript
// 從 URL 解析
// URL: /manga/reader/作品名/章節名
const pathParts = window.location.pathname.split('/');
this.category = pathParts[1];  // 'manga' 或 'pixiv'
this.chapterPath = pathParts.slice(3).join('/');  // '作品名/章節名'

// 設置端點
this.apiChapterEndpoint = `/api/${this.category}/chapter/`;
this.imagePrefix = `/${this.category}/image/`;
this.readerPrefix = `/${this.category}/reader/`;
```

## 🔍 URL 示例

### 漫畫流程

1. **訪問列表頁**
   ```
   URL: http://localhost:5000/manga
   ```

2. **點擊章節進入閱讀器**
   ```
   URL: http://localhost:5000/manga/reader/下一颤，性福/15
   ```

3. **閱讀器請求章節數據**
   ```
   API: /api/manga/chapter/下一颤，性福/15
   返回: {"images": [...], "navigation": {...}}
   ```

4. **載入圖片**
   ```
   圖片1: /manga/image/下一颤，性福/15/001.jpg
   圖片2: /manga/image/下一颤，性福/15/002.jpg
   ...
   ```

### PIXIV 流程

1. **訪問列表頁**
   ```
   URL: http://localhost:5000/pixiv
   ```

2. **點擊章節進入閱讀器**
   ```
   URL: http://localhost:5000/pixiv/reader/作者名/作品集/
   ```

3. **閱讀器請求章節數據**
   ```
   API: /api/pixiv/chapter/作者名/作品集
   返回: {"images": [...], "navigation": {...}}
   ```

4. **載入圖片**
   ```
   圖片: /pixiv/image/作者名/作品集/001.jpg
   ```

## ✨ 已實現功能

### 1. 路由分離
- ✅ 漫畫和 PIXIV 使用不同的 URL 路徑
- ✅ 清晰的 RESTful API 設計
- ✅ 獨立的資源路由

### 2. 導航系統
- ✅ 首頁導航欄可切換分類
- ✅ 閱讀器返回按鈕返回正確的列表頁
- ✅ 章節導航保持在當前分類

### 3. 懶加載優化
- ✅ Intersection Observer 智能加載
- ✅ 自動重試機制（最多3次）
- ✅ 30秒超時控制
- ✅ 手動重載功能
- ✅ 視覺化載入狀態

### 4. 路徑處理
- ✅ 支持中文路徑
- ✅ URL 編碼/解碼
- ✅ 跨平台路徑分隔符處理

## 🧪 測試建議

### 手動測試清單

1. **列表頁測試**
   - [ ] 訪問 `/manga` 顯示漫畫列表
   - [ ] 訪問 `/pixiv` 顯示 PIXIV 列表
   - [ ] 點擊導航欄可以切換分類
   - [ ] 搜尋功能正常

2. **閱讀器測試**
   - [ ] 點擊章節進入閱讀器
   - [ ] 圖片正常載入（檢查瀏覽器 Network 標籤）
   - [ ] 上一話/下一話按鈕正常
   - [ ] 返回按鈕返回正確的列表頁
   - [ ] 滾動時圖片懶加載正常

3. **錯誤處理測試**
   - [ ] 圖片載入失敗會顯示重試
   - [ ] 超時後會自動重試
   - [ ] 點擊失敗圖片可手動重載

4. **路徑測試**
   - [ ] 中文路徑正常
   - [ ] 特殊字符路徑正常（空格、符號等）
   - [ ] 多層目錄結構正常

## 📝 注意事項

1. **URL 編碼**
   - 章節路徑在 URL 中會自動編碼
   - API 請求時使用 `encodeURIComponent()`
   - 圖片路徑同樣需要編碼

2. **路徑分隔符**
   - 前端統一使用 `/` 作為分隔符
   - 後端會自動處理不同系統的路徑分隔符

3. **相對路徑 vs 絕對路徑**
   - 所有 API 調用都使用絕對路徑（以 `/` 開頭）
   - 避免使用相對路徑造成前綴重複

## 🚀 效能提升

- ⚡ 懶加載減少初始載入時間
- ⚡ 只載入可見區域圖片
- ⚡ 預載入提升閱讀流暢度
- ⚡ 超時控制避免長時間等待
- ⚡ 自動重試提高成功率

## 📊 錯誤日誌分析

如果遇到 404 錯誤，請檢查：
1. 後端路由是否正確定義
2. 前端 API 端點是否使用絕對路徑
3. URL 編碼是否正確
4. 圖片文件是否存在

## 🔧 除錯工具

**瀏覽器開發者工具（F12）：**
- Network 標籤：查看所有網絡請求
- Console 標籤：查看JavaScript錯誤
- Application 標籤：查看存儲和緩存

**後端日誌：**
```python
print(f"[DEBUG] 請求路徑: {request.path}")
print(f"[DEBUG] 章節路徑: {chapter_path}")
print(f"[DEBUG] 完整路徑: {full_path}")
```
