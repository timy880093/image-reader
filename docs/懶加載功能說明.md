# 圖片懶加載與超時處理 - 功能說明

## 🎯 問題解決

針對圖片路徑過長、載入超時等問題，實現了以下優化方案：

## ✨ 新增功能

### 1. **智能懶加載（Lazy Loading）**
- 使用 Intersection Observer API 實現高效的懶加載
- **只在圖片即將進入可視區域時才開始載入**
- 預載入範圍：當前可見圖片前後各 2 張（可配置）
- 提前 500px 開始載入（避免滾動時出現空白）

### 2. **自動重試機制**
- **最多自動重試 3 次**
- 重試間隔遞增：1秒、2秒、3秒
- 顯示重試進度和狀態
- 超時時間：30 秒

### 3. **手動重載功能**
- 點擊載入失敗的圖片可手動重新載入
- 支持強制重載（忽略重試次數限制）
- 視覺化的重載按鈕提示

### 4. **狀態管理**
每張圖片都有獨立的狀態追蹤：
- `loaded`: 是否已成功載入
- `loading`: 是否正在載入中
- `error`: 是否發生錯誤
- `retries`: 已重試次數
- `path`: 圖片路徑

### 5. **視覺化反饋**
- **⏳ 等待載入**：顯示圖片序號和提示文字
- **🔄 載入中**：旋轉動畫 + 載入提示
- **⚠️ 重試中**：警告圖標 + 重試次數
- **❌ 載入失敗**：錯誤提示 + 點擊重載按鈕
- **✅ 載入成功**：顯示圖片

## 🔧 技術實現

### Intersection Observer
```javascript
const options = {
    root: this.imageContainer,
    rootMargin: '500px',  // 提前 500px 開始加載
    threshold: 0
};
```

### 超時控制
```javascript
const timeoutId = setTimeout(() => {
    img.src = ''; // 取消加載
    this.handleImageError(index, '載入超時');
}, 30000); // 30秒超時
```

### 自動重試
```javascript
if (state.retries < this.maxRetries) {
    setTimeout(() => {
        this.loadImage(index);
    }, (this.maxRetries - state.retries) * 1000);
}
```

## 📊 性能優化

### 載入策略
1. **初始載入**：只載入前 2 張圖片
2. **滾動載入**：滾動到接近時才載入
3. **預載入**：當前圖片前後各 2 張
4. **緩存破壞**：URL 添加時間戳避免緩存問題

### 資源管理
- 使用 Map 和 Set 高效管理圖片狀態
- Observer 自動解除已載入圖片的觀察
- 避免重複載入同一張圖片

## 🎮 使用體驗

### 用戶操作
1. **正常閱讀**：向下滾動，圖片自動載入
2. **快速跳轉**：跳到任意位置，該位置的圖片優先載入
3. **載入失敗**：
   - 自動重試 3 次
   - 如果全部失敗，顯示重載按鈕
   - 點擊按鈕手動重載

### 狀態顯示
```
⏳ 第 5 頁
   滾動到此處自動載入
   
↓ (滾動接近)

🔄 載入第 5 頁...
   
↓ (載入中)

✅ [圖片顯示]
```

### 錯誤處理
```
❌ 載入失敗 - 第 5 頁
   ┌──────────────┐
   │ 點擊重新載入 │
   └──────────────┘
```

## ⚙️ 可配置參數

在 `MangaReader` 構造函數中可以調整：

```javascript
this.preloadDistance = 2;  // 預載入前後幾張圖片
this.maxRetries = 3;       // 最大重試次數
```

在 `setupIntersectionObserver` 中可以調整：

```javascript
rootMargin: '500px',  // 提前多少距離開始載入
```

在 `loadImage` 中可以調整：

```javascript
setTimeout(() => {...}, 30000);  // 超時時間（毫秒）
```

## 📈 效能提升

### 之前的問題
- ❌ 一次性載入所有圖片
- ❌ 大量圖片導致瀏覽器卡頓
- ❌ 長路徑容易超時
- ❌ 載入失敗無法恢復

### 現在的優勢
- ✅ 按需載入，節省流量
- ✅ 減少內存佔用
- ✅ 自動重試機制
- ✅ 手動重載選項
- ✅ 視覺化狀態反饋
- ✅ 更流暢的閱讀體驗

## 🌐 瀏覽器兼容性

- ✅ Chrome 51+
- ✅ Firefox 55+
- ✅ Safari 12.1+
- ✅ Edge 15+

## 🔍 調試建議

開啟瀏覽器開發者工具（F12）查看：
1. **Network 標籤**：觀察圖片載入時機和狀態
2. **Console 標籤**：查看可能的錯誤訊息
3. **Performance 標籤**：分析載入性能

## 💡 最佳實踐

1. **網路不穩定時**：系統會自動重試，請耐心等待
2. **載入緩慢時**：可以繼續向下滾動，會優先載入新位置的圖片
3. **載入失敗時**：點擊失敗圖片的重載按鈕
4. **大量圖片時**：建議分章節閱讀，避免一次載入過多

## 🔧 故障排除

### 如果圖片一直載入失敗
1. 檢查圖片路徑是否正確
2. 確認圖片文件沒有損壞
3. 檢查網絡連接
4. 嘗試刷新頁面（F5）
5. 查看瀏覽器控制台的錯誤訊息

### 如果載入很慢
1. 檢查圖片文件大小（建議 < 5MB）
2. 確認網絡速度
3. 考慮增加預載入距離
4. 減少同時載入的圖片數量

## 📝 更新日誌

**版本 2.0** - 2026-01-09
- ✨ 新增 Intersection Observer 懶加載
- ✨ 新增自動重試機制（最多 3 次）
- ✨ 新增 30 秒超時控制
- ✨ 新增手動重載功能
- ✨ 新增視覺化載入狀態
- ✨ 新增旋轉動畫效果
- ✨ 優化內存使用
- 🐛 修復長路徑超時問題
- 🐛 修復大量圖片卡頓問題
