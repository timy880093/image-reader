# æ¼«ç•«å°é¢é€£çµåŠŸèƒ½èªªæ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

åœ¨æ¼«ç•«åˆ—è¡¨é é¢ï¼Œé»æ“Šæ¼«ç•«å°é¢åœ–ç‰‡æ™‚ï¼Œæœƒè‡ªå‹•è®€å–è©²æ¼«ç•«è³‡æ–™å¤¾ä¸‹çš„ç¶²éš›ç¶²è·¯æ·å¾‘ï¼ˆ.url æ–‡ä»¶ï¼‰ï¼Œä¸¦åœ¨æ–°åˆ†é é–‹å•Ÿé€£çµã€‚å¦‚æœæ²’æœ‰ .url æ–‡ä»¶ï¼Œå‰‡å°é¢åœ–ç‰‡ä¸å¯é»æ“Šã€‚

## âœ¨ åŠŸèƒ½ç‰¹é»

### 1. è‡ªå‹•è®€å– .url æ–‡ä»¶
- æƒææ¼«ç•«è³‡æ–™å¤¾ä¸­çš„ `.url` æ–‡ä»¶
- è§£æ Windows ç¶²éš›ç¶²è·¯æ·å¾‘æ ¼å¼
- æå– URL é€£çµ

### 2. æ™ºèƒ½é¡¯ç¤º
- **æœ‰é€£çµ**ï¼šå°é¢åœ–ç‰‡å¯é»æ“Šï¼Œé¡¯ç¤º hover æ•ˆæœ
- **ç„¡é€£çµ**ï¼šå°é¢åœ–ç‰‡ä¸å¯é»æ“Šï¼Œç„¡ hover æ•ˆæœ

### 3. æ–°åˆ†é é–‹å•Ÿ
- ä½¿ç”¨ `target="_blank"` åœ¨æ–°åˆ†é é–‹å•Ÿ
- ä½¿ç”¨ `rel="noopener noreferrer"` ç¢ºä¿å®‰å…¨æ€§
- é»æ“Šå°é¢ä¸æœƒè§¸ç™¼å¡ç‰‡çš„é»æ“Šäº‹ä»¶

## ğŸ”§ æŠ€è¡“å¯¦ç¾

### å¾Œç«¯ä¿®æ”¹

#### 1. `src/modules/manga/service.py`

**æ–°å¢ `get_url_link()` æ–¹æ³•ï¼š**

```python
def get_url_link(self, manga_path):
    """
    ç²å–æ¼«ç•«è³‡æ–™å¤¾ä¸­çš„ç¶²éš›ç¶²è·¯æ·å¾‘é€£çµ
    
    Args:
        manga_path: æ¼«ç•«ç›®éŒ„è·¯å¾‘
        
    Returns:
        str: URL é€£çµï¼Œå¦‚æœæ²’æœ‰å‰‡è¿”å› None
    """
    manga_path = Path(manga_path)
    
    try:
        # æŸ¥æ‰¾ .url æ–‡ä»¶
        url_files = list(manga_path.glob('*.url'))
        
        if url_files:
            # è®€å–ç¬¬ä¸€å€‹ .url æ–‡ä»¶
            url_file = url_files[0]
            with open(url_file, 'r', encoding='utf-8') as f:
                content = f.read()
                
            # è§£æ .url æ–‡ä»¶æ ¼å¼
            # æ ¼å¼é€šå¸¸æ˜¯ï¼š
            # [InternetShortcut]
            # URL=https://example.com
            for line in content.split('\n'):
                line = line.strip()
                if line.startswith('URL='):
                    url = line[4:].strip()
                    return url
                    
    except Exception as e:
        print(f"è®€å– URL æ–‡ä»¶æ™‚å‡ºéŒ¯ ({manga_path.name}): {e}")
    
    return None
```

**ä¿®æ”¹ `get_manga_list()` æ–¹æ³•ï¼š**

```python
cover_image = self.get_cover_image(manga_dir)
url_link = self.get_url_link(manga_dir)  # æ–°å¢

manga_info = {
    'name': manga_dir.name,
    'path': formatPathForUrl(manga_dir.relative_to(self.root_path)),
    'chapters': chapters,
    'chapter_count': chapter_count,
    'cover_image': cover_image,
    'url_link': url_link  # æ–°å¢
}
```

### å‰ç«¯ä¿®æ”¹

#### 1. `src/static/js/manga/index.js`

**ä¿®æ”¹ `displayMangas()` å‡½æ•¸ï¼š**

```javascript
// å°é¢åœ–ç‰‡è™•ç†
let coverImageHtml;
if (manga.cover_image) {
    const imgTag = `<img src="${IMAGE_PREFIX}${encodeURIComponent(manga.cover_image)}" 
                         alt="${escapeHtml(manga.name)}" 
                         onerror="this.parentElement.innerHTML='<div class=&quot;manga-cover-placeholder-with-title&quot;>ğŸ“š</div>'">`;
    
    if (manga.url_link) {
        // æœ‰é€£çµï¼šå¯é»æ“Šï¼Œé–‹æ–°åˆ†é 
        coverImageHtml = `<a href="${escapeHtml(manga.url_link)}" 
                            target="_blank" 
                            rel="noopener noreferrer" 
                            onclick="event.stopPropagation();" 
                            class="manga-cover-link">${imgTag}</a>`;
    } else {
        // ç„¡é€£çµï¼šä¸å¯é»æ“Š
        coverImageHtml = imgTag;
    }
} else {
    // ç„¡å°é¢åœ–ç‰‡
    coverImageHtml = '<div class="manga-cover-placeholder-with-title">ğŸ“š</div>';
}
```

#### 2. `src/static/css/manga.css`

**æ–°å¢æ¨£å¼ï¼š**

```css
/* å°é¢åœ–ç‰‡é€£çµæ¨£å¼ */
.manga-cover-link {
    display: block;
    width: 100%;
    height: 100%;
    text-decoration: none;
}

.manga-cover-link img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    transition: transform 0.3s;
}

.manga-cover-link:hover img {
    transform: scale(1.05);
}

/* ç„¡é€£çµçš„å°é¢åœ–ç‰‡ä¸é¡¯ç¤º hover æ•ˆæœ */
.manga-cover > img:not(.manga-cover-link img) {
    cursor: default;
}
```

## ğŸ“‚ .url æ–‡ä»¶æ ¼å¼

Windows ç¶²éš›ç¶²è·¯æ·å¾‘çš„æ¨™æº–æ ¼å¼ï¼š

```ini
[InternetShortcut]
URL=https://example.com/manga-page
IconIndex=0
```

**æœ€å°æ ¼å¼ï¼ˆåªéœ€è¦é€™å…©è¡Œï¼‰ï¼š**

```ini
[InternetShortcut]
URL=https://example.com
```

## ğŸ¯ ä½¿ç”¨æ–¹å¼

### 1. å‰µå»º .url æ–‡ä»¶

**æ–¹æ³• Aï¼šæ‰‹å‹•å‰µå»º**

1. åœ¨æ¼«ç•«è³‡æ–™å¤¾ä¸­å‰µå»ºæ–‡æœ¬æ–‡ä»¶
2. å‘½åç‚º `link.url` æˆ–ä»»ä½• `.url` çµå°¾çš„åç¨±
3. å…§å®¹æ ¼å¼ï¼š
   ```ini
   [InternetShortcut]
   URL=https://example.com
   ```

**æ–¹æ³• Bï¼šå¾ç€è¦½å™¨æ‹–æ›³**

1. åœ¨ç€è¦½å™¨ä¸­æ‰“é–‹ç›®æ¨™ç¶²é 
2. å°‡ç¶²å€åˆ—çš„åœ–æ¨™æ‹–æ›³åˆ°æ¼«ç•«è³‡æ–™å¤¾
3. Windows æœƒè‡ªå‹•å‰µå»º .url æ–‡ä»¶

**æ–¹æ³• Cï¼šä½¿ç”¨ PowerShell æ‰¹é‡å‰µå»º**

```powershell
# å‰µå»ºå–®å€‹ .url æ–‡ä»¶
$url = "https://example.com"
$content = @"
[InternetShortcut]
URL=$url
"@
$content | Out-File -FilePath "E:\manga\æ¼«ç•«åç¨±\link.url" -Encoding utf8
```

### 2. æ¸¬è©¦åŠŸèƒ½

1. å•Ÿå‹•æœå‹™å™¨
2. æ‰“é–‹æ¼«ç•«åˆ—è¡¨é é¢
3. æ‰¾åˆ°æœ‰ .url æ–‡ä»¶çš„æ¼«ç•«
4. é»æ“Šå°é¢åœ–ç‰‡
5. æ‡‰è©²åœ¨æ–°åˆ†é é–‹å•Ÿé€£çµ

## ğŸ“Š è¡Œç‚ºå°ç…§è¡¨

| æƒ…æ³ | å°é¢åœ–ç‰‡ | é»æ“Šè¡Œç‚º | Hover æ•ˆæœ |
|------|---------|---------|-----------|
| æœ‰å°é¢ + æœ‰é€£çµ | é¡¯ç¤ºåœ–ç‰‡ | é–‹æ–°åˆ†é  | æ”¾å¤§ 1.05 å€ |
| æœ‰å°é¢ + ç„¡é€£çµ | é¡¯ç¤ºåœ–ç‰‡ | ç„¡åæ‡‰ | ç„¡ |
| ç„¡å°é¢ + æœ‰é€£çµ | é¡¯ç¤º ğŸ“š | ç„¡åæ‡‰ | ç„¡ |
| ç„¡å°é¢ + ç„¡é€£çµ | é¡¯ç¤º ğŸ“š | ç„¡åæ‡‰ | ç„¡ |

## ğŸ” é™¤éŒ¯æŒ‡å—

### å•é¡Œ 1ï¼šé»æ“Šå°é¢æ²’æœ‰åæ‡‰

**æª¢æŸ¥æ­¥é©Ÿï¼š**

1. **ç¢ºèª .url æ–‡ä»¶å­˜åœ¨**
   ```powershell
   Get-ChildItem "E:\manga\æ¼«ç•«åç¨±" -Filter "*.url"
   ```

2. **æª¢æŸ¥ .url æ–‡ä»¶å…§å®¹**
   ```powershell
   Get-Content "E:\manga\æ¼«ç•«åç¨±\link.url"
   ```

3. **æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°**
   - æŒ‰ F12 æ‰“é–‹é–‹ç™¼è€…å·¥å…·
   - æŸ¥çœ‹ Console æ˜¯å¦æœ‰éŒ¯èª¤
   - æŸ¥çœ‹ Network æ¨™ç±¤ï¼Œç¢ºèª API è¿”å›çš„æ•¸æ“šåŒ…å« `url_link`

4. **æª¢æŸ¥ API éŸ¿æ‡‰**
   ```javascript
   // åœ¨ç€è¦½å™¨ Console åŸ·è¡Œ
   fetch('/manga/api/list?page=1&per_page=6&skip_chapters=false')
     .then(r => r.json())
     .then(data => console.log(data.mangas[0].url_link));
   ```

### å•é¡Œ 2ï¼šé€£çµæ ¼å¼éŒ¯èª¤

**å¸¸è¦‹éŒ¯èª¤ï¼š**

```ini
# âŒ éŒ¯èª¤ï¼šç¼ºå°‘ [InternetShortcut] æ¨™é¡Œ
URL=https://example.com

# âŒ éŒ¯èª¤ï¼šURL å‰æœ‰ç©ºæ ¼
[InternetShortcut]
 URL=https://example.com

# âœ… æ­£ç¢ºæ ¼å¼
[InternetShortcut]
URL=https://example.com
```

### å•é¡Œ 3ï¼šç·¨ç¢¼å•é¡Œ

å¦‚æœ URL åŒ…å«ä¸­æ–‡æˆ–ç‰¹æ®Šå­—ç¬¦ï¼š

```powershell
# ç¢ºä¿ä½¿ç”¨ UTF-8 ç·¨ç¢¼ä¿å­˜
$content = @"
[InternetShortcut]
URL=https://example.com/æ¼«ç•«
"@
$content | Out-File -FilePath "link.url" -Encoding utf8
```

### å•é¡Œ 4ï¼šå¤šå€‹ .url æ–‡ä»¶

å¦‚æœè³‡æ–™å¤¾ä¸­æœ‰å¤šå€‹ .url æ–‡ä»¶ï¼Œç³»çµ±æœƒè®€å–ç¬¬ä¸€å€‹æ‰¾åˆ°çš„æ–‡ä»¶ã€‚

**å»ºè­°ï¼š**
- æ¯å€‹æ¼«ç•«è³‡æ–™å¤¾åªæ”¾ä¸€å€‹ .url æ–‡ä»¶
- å‘½åç‚º `link.url` æˆ– `source.url` æ–¹ä¾¿è­˜åˆ¥

## ğŸ›¡ï¸ å®‰å…¨æ€§è€ƒé‡

### 1. XSS é˜²è­·

ä½¿ç”¨ `escapeHtml()` å‡½æ•¸è™•ç† URLï¼š

```javascript
coverImageHtml = `<a href="${escapeHtml(manga.url_link)}" ...>`;
```

### 2. æ–°åˆ†é å®‰å…¨æ€§

ä½¿ç”¨ `rel="noopener noreferrer"`ï¼š

```html
<a href="..." target="_blank" rel="noopener noreferrer">
```

é€™å¯ä»¥é˜²æ­¢ï¼š
- æ–°é é¢é€šé `window.opener` è¨ªå•åŸé é¢
- Referer æ´©æ¼

### 3. äº‹ä»¶å†’æ³¡è™•ç†

ä½¿ç”¨ `event.stopPropagation()` é˜²æ­¢è§¸ç™¼å¡ç‰‡é»æ“Šï¼š

```javascript
onclick="event.stopPropagation();"
```

## ğŸ“ æ‰¹é‡å‰µå»º .url æ–‡ä»¶è…³æœ¬

å¦‚æœéœ€è¦ç‚ºå¤šå€‹æ¼«ç•«æ‰¹é‡å‰µå»º .url æ–‡ä»¶ï¼š

```powershell
# batch-create-urls.ps1

# é…ç½®
$mangaRoot = "E:\manga"
$urlMappings = @{
    "æµ·è³Šç‹" = "https://example.com/one-piece"
    "ç«å½±å¿è€…" = "https://example.com/naruto"
    "æ­»ç¥" = "https://example.com/bleach"
}

# æ‰¹é‡å‰µå»º
foreach ($manga in $urlMappings.Keys) {
    $mangaPath = Join-Path $mangaRoot $manga
    
    if (Test-Path $mangaPath) {
        $urlFile = Join-Path $mangaPath "link.url"
        $url = $urlMappings[$manga]
        
        $content = @"
[InternetShortcut]
URL=$url
"@
        
        $content | Out-File -FilePath $urlFile -Encoding utf8
        Write-Host "âœ… å·²å‰µå»º: $urlFile" -ForegroundColor Green
    } else {
        Write-Host "âŒ è³‡æ–™å¤¾ä¸å­˜åœ¨: $mangaPath" -ForegroundColor Red
    }
}

Write-Host "`nå®Œæˆï¼" -ForegroundColor Cyan
```

**ä½¿ç”¨æ–¹å¼ï¼š**

```powershell
# 1. ä¿®æ”¹è…³æœ¬ä¸­çš„è·¯å¾‘å’Œ URL æ˜ å°„
# 2. åŸ·è¡Œè…³æœ¬
.\batch-create-urls.ps1
```

## âœ… æ¸¬è©¦æª¢æŸ¥æ¸…å–®

### åŸºæœ¬åŠŸèƒ½
- [ ] æœ‰ .url æ–‡ä»¶çš„æ¼«ç•«ï¼Œå°é¢å¯é»æ“Š
- [ ] ç„¡ .url æ–‡ä»¶çš„æ¼«ç•«ï¼Œå°é¢ä¸å¯é»æ“Š
- [ ] é»æ“Šå°é¢åœ¨æ–°åˆ†é é–‹å•Ÿ
- [ ] é»æ“Šå°é¢ä¸è§¸ç™¼å¡ç‰‡é»æ“Šäº‹ä»¶

### è¦–è¦ºæ•ˆæœ
- [ ] æœ‰é€£çµçš„å°é¢ hover æ™‚æ”¾å¤§
- [ ] ç„¡é€£çµçš„å°é¢ hover ç„¡æ•ˆæœ
- [ ] æ”¶è—æŒ‰éˆ•ä¸å—å½±éŸ¿

### é‚Šç•Œæƒ…æ³
- [ ] è³‡æ–™å¤¾ä¸­æœ‰å¤šå€‹ .url æ–‡ä»¶
- [ ] .url æ–‡ä»¶æ ¼å¼éŒ¯èª¤
- [ ] .url æ–‡ä»¶ç·¨ç¢¼å•é¡Œ
- [ ] URL åŒ…å«ç‰¹æ®Šå­—ç¬¦

### å®‰å…¨æ€§
- [ ] URL æ­£ç¢ºè½‰ç¾©ï¼Œç„¡ XSS é¢¨éšª
- [ ] æ–°åˆ†é ä½¿ç”¨ noopener noreferrer
- [ ] äº‹ä»¶å†’æ³¡æ­£ç¢ºè™•ç†

## ğŸ‰ å®Œæˆç‹€æ…‹

åŠŸèƒ½å·²å®Œæ•´å¯¦ç¾ï¼š
- âœ… è®€å–æ¼«ç•«è³‡æ–™å¤¾ä¸­çš„ .url æ–‡ä»¶
- âœ… è§£æ Windows ç¶²éš›ç¶²è·¯æ·å¾‘æ ¼å¼
- âœ… æœ‰é€£çµæ™‚å°é¢å¯é»æ“Š
- âœ… ç„¡é€£çµæ™‚å°é¢ä¸å¯é»æ“Š
- âœ… æ–°åˆ†é é–‹å•Ÿé€£çµ
- âœ… å®‰å…¨æ€§é˜²è­·

## ğŸ“š ç›¸é—œæ–‡ä»¶

- `src/modules/manga/service.py` - å¾Œç«¯æœå‹™å±¤
- `src/static/js/manga/index.js` - å‰ç«¯é‚è¼¯
- `src/static/css/manga.css` - æ¨£å¼å®šç¾©
