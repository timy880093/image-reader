# 章節選單功能說明

## 📋 功能概述

將漫畫 Reader 頁面的「回到目錄」按鈕改為章節選單，用戶可以直接在閱讀器中選擇並跳轉到任意章節，並根據 [只顯示收藏] 設定來篩選顯示的章節。

## ✨ 功能特點

### 1. 章節選單按鈕
- 取代原本的「回到目錄」按鈕
- 顯示「📚 章節選單」文字和下拉箭頭
- 點擊展開/收起選單

### 2. 下拉選單
- 顯示所有可用章節
- 當前章節高亮顯示並標記「● 當前」
- 最大高度 400px，超過則可滾動
- 自動滾動到當前章節位置

### 3. 章節篩選
- **未勾選 [只顯示收藏]**：顯示所有章節
- **勾選 [只顯示收藏]**：只顯示收藏的章節
- 與主頁的設定同步（使用 localStorage）

### 4. 互動效果
- Hover 時章節項目背景變色
- 當前章節使用特殊背景色
- 點擊章節立即跳轉
- 點擊選單外部自動關閉

## 🔧 技術實現

### 前端修改

#### 1. `src/modules/manga/templates/manga/reader.html`

**替換工具列左側：**

```html
<div class="toolbar-left">
    <div class="chapter-menu-container">
        <button class="chapter-menu-btn" id="chapterMenuBtn" onclick="toggleChapterMenu()">
            📚 章節選單
        </button>
        <div class="chapter-menu" id="chapterMenu">
            <div class="chapter-menu-header">選擇章節</div>
            <div id="chapterMenuItems"></div>
        </div>
    </div>
    <div id="chapterInfo" class="chapter-info">載入中...</div>
</div>
```

**新增 CSS 樣式：**

```css
.chapter-menu-container {
    position: relative;
    display: inline-block;
}

.chapter-menu-btn {
    background: #667eea;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.3s;
    display: flex;
    align-items: center;
    gap: 5px;
}

.chapter-menu-btn::after {
    content: '▼';
    font-size: 10px;
}

.chapter-menu {
    position: absolute;
    top: 100%;
    left: 0;
    margin-top: 5px;
    background: rgba(0, 0, 0, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    min-width: 250px;
    max-height: 400px;
    overflow-y: auto;
    display: none;
    z-index: 2000;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
}

.chapter-menu.show {
    display: block;
}

.chapter-menu-item {
    padding: 10px 15px;
    cursor: pointer;
    transition: background-color 0.2s;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chapter-menu-item:hover {
    background: rgba(102, 126, 234, 0.3);
}

.chapter-menu-item.current {
    background: rgba(102, 126, 234, 0.5);
    font-weight: bold;
}
```

#### 2. `src/static/js/manga/reader.js`

**新增屬性：**

```javascript
this.allChapters = [];  // 所有章節列表
```

**新增方法：**

```javascript
async loadAllChapters() {
    if (!this.navigation || !this.navigation.manga_name) return;

    try {
        // 獲取漫畫的所有章節
        const mangaPath = this.chapterPath.split('/').slice(0, -1).join('/');
        let apiUrl = `/manga/api/detail/${encodeURIComponent(mangaPath)}`;
        
        const response = await fetch(apiUrl);
        if (!response.ok) return;

        const data = await response.json();
        let chapters = data.chapters || [];

        // 如果啟用只顯示收藏，則篩選收藏的章節
        if (this.favoriteOnly) {
            const favoriteChapters = [];
            for (const chapter of chapters) {
                try {
                    const statusResponse = await fetch(`/manga/api/status/${encodeURIComponent(chapter.path)}`);
                    if (statusResponse.ok) {
                        const statusData = await statusResponse.json();
                        if (statusData.status === 'favorite') {
                            favoriteChapters.push(chapter);
                        }
                    }
                } catch (e) {
                    console.warn('無法檢查章節狀態:', e);
                }
            }
            chapters = favoriteChapters.length > 0 ? favoriteChapters : chapters;
        }

        this.allChapters = chapters;
        this.renderChapterMenu();

    } catch (error) {
        console.warn('無法載入章節列表:', error);
    }
}

renderChapterMenu() {
    if (!this.allChapters || this.allChapters.length === 0) {
        this.chapterMenuItems.innerHTML = '<div style="padding: 15px; text-align: center; color: #999;">無可用章節</div>';
        return;
    }

    const currentPath = this.chapterPath;
    
    const menuHtml = this.allChapters.map(chapter => {
        const isCurrent = chapter.path === currentPath;
        const currentClass = isCurrent ? 'current' : '';
        const currentBadge = isCurrent ? '<span class="chapter-menu-item-badge">● 當前</span>' : '';
        
        return `
            <div class="chapter-menu-item ${currentClass}" onclick="window.reader.gotoChapter('${chapter.path}')">
                <span class="chapter-menu-item-name">${this.escapeHtml(chapter.name)}</span>
                ${currentBadge}
            </div>
        `;
    }).join('');

    this.chapterMenuItems.innerHTML = menuHtml;

    // 滾動到當前章節
    setTimeout(() => {
        const currentItem = this.chapterMenuItems.querySelector('.current');
        if (currentItem) {
            currentItem.scrollIntoView({ block: 'center' });
        }
    }, 100);
}

toggleChapterMenu() {
    this.chapterMenu.classList.toggle('show');
}

closeChapterMenu() {
    this.chapterMenu.classList.remove('show');
}

gotoChapter(chapterPath) {
    window.location.href = `/manga/reader/${encodeURIComponent(chapterPath)}`;
}
```

**修改事件綁定：**

```javascript
bindEvents() {
    // 鍵盤事件
    document.addEventListener('keydown', (e) => this.handleKeyboard(e));

    // 滾動事件來更新頁碼顯示
    this.imageContainer.addEventListener('scroll', () => {
        this.updatePageInfo();
    });

    // 點擊外部關閉選單
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.chapter-menu-container')) {
            this.closeChapterMenu();
        }
    });
}
```

## 🎯 使用流程

### 場景 1：查看所有章節

1. 進入漫畫閱讀器
2. 點擊左上角「📚 章節選單」按鈕
3. 選單展開，顯示所有章節
4. 當前章節高亮顯示並標記「● 當前」
5. 點擊任意章節跳轉

### 場景 2：只顯示收藏章節

1. 在主頁勾選 [只顯示收藏章節]
2. 進入漫畫閱讀器
3. 點擊「📚 章節選單」按鈕
4. 選單只顯示收藏的章節
5. 點擊任意收藏章節跳轉

### 場景 3：快速跳轉

假設漫畫有 100 話，當前在第 50 話：

1. 點擊章節選單
2. 選單自動滾動到第 50 話位置
3. 可以快速向上/向下滾動選擇其他章節
4. 點擊第 1 話或第 100 話快速跳轉

## 📊 功能對照表

| 功能 | 舊版（回到目錄） | 新版（章節選單） |
|------|----------------|----------------|
| 查看章節列表 | 需返回列表頁 | 直接在閱讀器中查看 |
| 跳轉章節 | 需返回列表頁再點擊 | 直接點擊選單項目 |
| 當前章節標記 | 無 | 高亮顯示 + 標記 |
| 收藏篩選 | 不支援 | 支援 |
| 操作步驟 | 2 步（返回 → 點擊） | 1 步（選單 → 點擊） |

## 🎨 視覺設計

### 選單按鈕

```
┌─────────────────┐
│ 📚 章節選單 ▼   │
└─────────────────┘
```

### 展開的選單

```
┌─────────────────────────┐
│ 選擇章節                 │
├─────────────────────────┤
│ 第001話                  │
│ 第002話                  │
│ 第003話         ● 當前   │ ← 高亮
│ 第004話                  │
│ 第005話                  │
│ ...                      │
└─────────────────────────┘
```

### 顏色方案

| 元素 | 顏色 | 說明 |
|------|------|------|
| 按鈕背景 | `#667eea` | 紫藍色 |
| 選單背景 | `rgba(0,0,0,0.95)` | 半透明黑色 |
| 選單邊框 | `rgba(255,255,255,0.3)` | 半透明白色 |
| 章節項目 Hover | `rgba(102,126,234,0.3)` | 淺紫藍色 |
| 當前章節背景 | `rgba(102,126,234,0.5)` | 中紫藍色 |
| 當前標記 | `#ffd700` | 金色 |

## 🔍 與 [只顯示收藏] 的整合

### 數據流程

```
1. 頁面載入
   ↓
2. 從 localStorage 讀取 favoriteOnly 設定
   ↓
3. 載入章節列表
   ↓
4. 如果 favoriteOnly = true
   ├─ 遍歷所有章節
   ├─ 檢查每個章節的收藏狀態
   └─ 只保留 status = 'favorite' 的章節
   ↓
5. 渲染章節選單
```

### API 調用

```javascript
// 獲取章節列表
GET /manga/api/detail/{manga_path}

// 檢查章節收藏狀態（如果 favoriteOnly = true）
GET /manga/api/status/{chapter_path}
```

### 狀態同步

| 位置 | 設定來源 | 影響範圍 |
|------|---------|---------|
| 主頁 | localStorage | 章節列表顯示 |
| Reader | localStorage | 章節選單 + 上一頁/下一頁 |

## 🐛 邊界情況處理

### 1. 沒有章節

**情況：** 漫畫資料夾為空或沒有有效章節

**處理：**
```html
<div style="padding: 15px; text-align: center; color: #999;">
    無可用章節
</div>
```

### 2. 所有章節都未收藏

**情況：** 勾選 [只顯示收藏]，但沒有任何收藏章節

**處理：** 回退顯示所有章節

```javascript
chapters = favoriteChapters.length > 0 ? favoriteChapters : chapters;
```

### 3. 當前章節不在篩選結果中

**情況：** 當前章節未收藏，但勾選了 [只顯示收藏]

**處理：** 選單中不會高亮任何項目，但仍可正常瀏覽

### 4. 章節名稱過長

**情況：** 章節名稱超過選單寬度

**處理：** 使用 `text-overflow: ellipsis` 截斷（可選）

## ✅ 測試檢查清單

### 基本功能
- [ ] 章節選單按鈕顯示正常
- [ ] 點擊按鈕展開選單
- [ ] 選單顯示所有章節
- [ ] 當前章節高亮顯示
- [ ] 點擊章節可以跳轉
- [ ] 點擊外部關閉選單

### 收藏篩選
- [ ] 未勾選 [只顯示收藏]：顯示所有章節
- [ ] 勾選 [只顯示收藏]：只顯示收藏章節
- [ ] 沒有收藏章節時回退顯示全部
- [ ] 設定與主頁同步

### 視覺效果
- [ ] 選單樣式正確
- [ ] Hover 效果正常
- [ ] 當前章節背景色正確
- [ ] 滾動條樣式正確
- [ ] 自動滾動到當前章節

### 邊界情況
- [ ] 沒有章節時顯示提示
- [ ] 章節數量很多時滾動正常
- [ ] 章節名稱很長時顯示正常
- [ ] 快速點擊不會出錯

### 響應式
- [ ] 桌面版顯示正常
- [ ] 移動版顯示正常
- [ ] 選單不超出視窗範圍

## 🎉 完成狀態

功能已完整實現：
- ✅ 將「回到目錄」改為章節選單
- ✅ 顯示所有可用章節
- ✅ 當前章節高亮標記
- ✅ 支援 [只顯示收藏] 篩選
- ✅ 點擊章節直接跳轉
- ✅ 點擊外部自動關閉
- ✅ 自動滾動到當前章節

## 📚 相關文件

- `src/modules/manga/templates/manga/reader.html` - Reader 模板
- `src/static/js/manga/reader.js` - Reader JavaScript
- `docs/章節收藏功能說明.md` - 收藏功能文檔

## 🔄 未來優化建議

1. **搜尋功能**
   - 在選單頂部添加搜尋框
   - 即時篩選章節

2. **章節分組**
   - 按卷數分組顯示
   - 可折疊/展開分組

3. **快捷鍵**
   - 按 `C` 鍵開啟章節選單
   - 方向鍵選擇章節
   - Enter 鍵跳轉

4. **章節預覽**
   - Hover 時顯示封面圖
   - 顯示章節頁數

5. **歷史記錄**
   - 顯示最近閱讀的章節
   - 快速返回上次位置

6. **書籤功能**
   - 在選單中顯示書籤標記
   - 快速跳轉到書籤位置
