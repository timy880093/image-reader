# PIXIV åŠŸèƒ½å„ªåŒ–èªªæ˜

## ğŸ“‹ éœ€æ±‚

### PIXIV åˆ—è¡¨é é¢
- âœ… åˆå§‹åªè¼‰å…¥ 6 å€‹è³‡æ–™å¤¾
- âœ… æ»¾è¼ªæ²å‹•æ™‚æ‰è¼‰å…¥æ›´å¤š
- âœ… é¡¯ç¤ºåœ–ç‰‡å¼µæ•¸ï¼ˆä¸å¯¦éš›è¼‰å…¥åœ–ç‰‡ï¼‰
- âœ… è³‡æ–™å¤¾å…§ç„¡å­è³‡æ–™å¤¾ï¼ˆç›´æ¥æ˜¯åœ–ç‰‡ï¼‰

### PIXIV é–±è®€å™¨
- âœ… ä¾åº lazy loading å…¨éƒ¨åœ–ç‰‡
- âœ… æ¯å¼µè¼‰å…¥å®Œæˆç«‹å³é¡¯ç¤º
- âœ… è‡ªå‹•ç¹¼çºŒè¼‰å…¥ä¸‹ä¸€å¼µ
- âœ… é¿å…ä¸€æ¬¡å…¨éƒ¨ç­‰å¾…å°è‡´ timeout

## âœ¨ å¯¦ç¾çš„å„ªåŒ–

### 1. å¾Œç«¯å„ªåŒ– (app.py)

#### æ–°å¢å¿«é€Ÿåœ–ç‰‡è¨ˆæ•¸æ–¹æ³•
```python
def _count_images_fast(self, manga_path):
    """å¿«é€Ÿçµ±è¨ˆåœ–ç‰‡æ•¸é‡ï¼ˆç”¨æ–¼ PIXIVï¼‰"""
    try:
        count = sum(
            1 for f in manga_path.iterdir() 
            if f.is_file() and f.suffix.lower() in IMAGE_EXTENSIONS
        )
        return count
    except:
        return 0
```

#### å„ªåŒ–åˆ—è¡¨è¼‰å…¥é‚è¼¯
```python
if subdirs:
    # æœ‰å­è³‡æ–™å¤¾ï¼ˆæ¼«ç•«æ¨¡å¼ï¼‰
    chapter_count = len(subdirs)
else:
    # æ²’æœ‰å­è³‡æ–™å¤¾ï¼ˆPIXIV æ¨¡å¼ï¼‰- ç›´æ¥çµ±è¨ˆåœ–ç‰‡æ•¸
    chapter_count = self._count_images_fast(manga_dir)
```

#### PIXIV API é»˜èªæ¯é  6 å€‹
```python
@app.route('/api/pixiv/list')
def get_pixiv_list():
    page = request.args.get('page', 1, type=int)
    per_page = request.args.get('per_page', 6, type=int)  # é»˜èª 6 å€‹
    skip_chapters = request.args.get('skip_chapters', 'true').lower() == 'true'
    
    result = pixiv_reader.get_manga_list(page=page, per_page=per_page, skip_chapters=skip_chapters)
    return jsonify(result)
```

#### ç« ç¯€åç¨±å„ªåŒ–
```python
# PIXIV æ¨¡å¼ï¼šä½¿ç”¨è³‡æ–™å¤¾åç¨±è€Œä¸æ˜¯ã€Œå–®è¡Œæœ¬ã€
chapters.append({
    'name': manga_path.name,  # è³‡æ–™å¤¾åç¨±
    'path': formatPathForUrl(manga_path.relative_to(self.root_path)),
    'image_count': len(images)
})
```

### 2. å‰ç«¯å„ªåŒ– (index.html)

#### é¡¯ç¤ºåœ–ç‰‡å¼µæ•¸
```javascript
if (currentCategory === 'pixiv') {
    // PIXIVï¼šé¡¯ç¤ºåœ–ç‰‡å¼µæ•¸
    chaptersHtml = `
        <div class="chapter-item" style="justify-content: center; cursor: default;">
            <span class="chapter-name">ğŸ“· ${manga.chapter_count} å¼µåœ–ç‰‡</span>
        </div>
    `;
}
```

#### ç„¡é™æ»¾å‹•ï¼ˆå·²å¯¦ç¾ï¼‰
- ç›£è½æ»¾å‹•äº‹ä»¶
- è·é›¢åº•éƒ¨ 200px æ™‚è‡ªå‹•è¼‰å…¥ä¸‹ä¸€é 
- æ¯é  6 å€‹è³‡æ–™å¤¾

### 3. é–±è®€å™¨å„ªåŒ– (reader.html - å·²å¯¦ç¾)

#### é †åºè¼‰å…¥æ¨¡å¼
```javascript
loadAllImagesSequentially() {
    const loadNext = (index) => {
        if (index >= this.images.length) {
            // å…¨éƒ¨è¼‰å…¥å®Œæˆ
            return;
        }
        this.loadImageSequentially(index, loadNext);
    };
    
    // å¾ç¬¬ä¸€å¼µé–‹å§‹
    loadNext(0);
}
```

#### æ¯å¼µåœ–ç‰‡ç¨ç«‹è™•ç†
```javascript
async loadImageSequentially(index, onComplete) {
    const state = this.imageStates.get(index);
    if (!state) return;
    
    state.loading = true;
    this.loadingQueue.add(index);
    
    const placeholder = document.getElementById(`placeholder-${index}`);
    // é¡¯ç¤ºè¼‰å…¥ä¸­å‹•ç•«...
    
    const img = new Image();
    
    // 30ç§’è¶…æ™‚
    const timeoutId = setTimeout(() => {
        this.handleImageErrorSequential(index, 'è¼‰å…¥è¶…æ™‚', onComplete);
    }, 30000);
    
    img.onload = () => {
        clearTimeout(timeoutId);
        // ç«‹å³é¡¯ç¤ºåœ–ç‰‡
        placeholder.replaceWith(img);
        state.loaded = true;
        state.loading = false;
        
        // ç¹¼çºŒè¼‰å…¥ä¸‹ä¸€å¼µ
        if (onComplete) onComplete(index + 1);
    };
    
    img.onerror = () => {
        clearTimeout(timeoutId);
        this.handleImageErrorSequential(index, 'è¼‰å…¥å¤±æ•—', onComplete);
    };
    
    img.src = `/image/${encodeURIComponent(state.path)}?category=${this.category}&t=${Date.now()}`;
}
```

## ğŸ“Š PIXIV å·¥ä½œæµç¨‹

### åˆ—è¡¨é é¢è¼‰å…¥æµç¨‹
```
1. è¨ªå• /pixiv
   â†“
2. è¼‰å…¥å‰ 6 å€‹è³‡æ–™å¤¾
   - åªæƒæè³‡æ–™å¤¾åç¨±
   - å¿«é€Ÿçµ±è¨ˆåœ–ç‰‡æ•¸é‡
   - ä¸è¼‰å…¥ä»»ä½•åœ–ç‰‡
   â†“
3. é¡¯ç¤ºè³‡æ–™å¤¾å¡ç‰‡
   - è³‡æ–™å¤¾åç¨±
   - "ğŸ“· X å¼µåœ–ç‰‡"
   â†“
4. æ»¾å‹•åˆ°åº•éƒ¨æ™‚
   - è‡ªå‹•è¼‰å…¥ä¸‹ 6 å€‹è³‡æ–™å¤¾
   - ç„¡é™æ»¾å‹•ç›´åˆ°æ²’æœ‰æ›´å¤š
```

### é»æ“Šé€²å…¥é–±è®€å™¨æµç¨‹
```
1. é»æ“Š PIXIV è³‡æ–™å¤¾
   â†“
2. ç²å–è³‡æ–™å¤¾è©³æƒ…
   - API: /api/pixiv/detail/{path}
   - è¿”å›åœ–ç‰‡åˆ—è¡¨
   â†“
3. é€²å…¥é–±è®€å™¨é é¢
   â†“
4. é †åºè¼‰å…¥åœ–ç‰‡
   - è¼‰å…¥ç¬¬ 1 å¼µ â†’ é¡¯ç¤º â†’ è¼‰å…¥ç¬¬ 2 å¼µ â†’ é¡¯ç¤º â†’ ...
   - æ¯å¼µåœ–ç‰‡ç¨ç«‹è™•ç†
   - è¼‰å…¥å®Œæˆç«‹å³é¡¯ç¤º
   - å¤±æ•—è‡ªå‹•é‡è©¦ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰
   â†“
5. å…¨éƒ¨è¼‰å…¥å®Œæˆ
```

## ğŸ¯ æ€§èƒ½å„ªåŒ–æ•ˆæœ

### åˆ—è¡¨é é¢
| é …ç›® | å„ªåŒ–å‰ | å„ªåŒ–å¾Œ |
|------|--------|--------|
| åˆå§‹è¼‰å…¥ | è¼‰å…¥æ‰€æœ‰è³‡æ–™å¤¾ | åªè¼‰å…¥ 6 å€‹ |
| åœ–ç‰‡è™•ç† | æƒææ‰€æœ‰åœ–ç‰‡ | åªè¨ˆæ•¸ï¼Œä¸è¼‰å…¥ |
| è¼‰å…¥æ™‚é–“ | å¯èƒ½ 10-30 ç§’ | < 1 ç§’ |
| å…§å­˜ä½¿ç”¨ | é«˜ï¼ˆè¼‰å…¥æ‰€æœ‰æ•¸æ“šï¼‰ | ä½ï¼ˆæŒ‰éœ€è¼‰å…¥ï¼‰ |

### é–±è®€å™¨é é¢
| é …ç›® | å„ªåŒ–å‰ | å„ªåŒ–å¾Œ |
|------|--------|--------|
| è¼‰å…¥æ–¹å¼ | æ»¾å‹•è§¸ç™¼æ‡¶åŠ è¼‰ | é †åºè‡ªå‹•è¼‰å…¥ |
| é¡¯ç¤ºæ™‚æ©Ÿ | éœ€è¦æ»¾å‹•åˆ°ä½ç½® | ç«‹å³é¡¯ç¤º |
| è¶…æ™‚é¢¨éšª | é«˜ï¼ˆä¸€æ¬¡è¼‰å…¥å¤šå¼µï¼‰ | ä½ï¼ˆé€å¼µè¼‰å…¥ï¼‰ |
| ç”¨æˆ¶é«”é©— | éœ€è¦ç­‰å¾…å’Œæ»¾å‹• | è‡ªå‹•ä¾åºå‘ˆç¾ |

## ğŸ”§ é…ç½®èª¿æ•´

### èª¿æ•´æ¯é è³‡æ–™å¤¾æ•¸é‡
åœ¨ `app.py` ä¸­ä¿®æ”¹ï¼š
```python
@app.route('/api/pixiv/list')
def get_pixiv_list():
    per_page = request.args.get('per_page', 6, type=int)  # æ”¹ç‚ºå…¶ä»–æ•¸å­—
```

### èª¿æ•´åœ–ç‰‡è¼‰å…¥è¶…æ™‚
åœ¨ `reader.html` ä¸­ä¿®æ”¹ï¼š
```javascript
const timeoutId = setTimeout(() => {
    this.handleImageErrorSequential(index, 'è¼‰å…¥è¶…æ™‚', onComplete);
}, 30000);  // æ”¹ç‚ºå…¶ä»–æ¯«ç§’æ•¸
```

### èª¿æ•´è‡ªå‹•é‡è©¦æ¬¡æ•¸
åœ¨ `reader.html` çš„æ§‹é€ å‡½æ•¸ä¸­ï¼š
```javascript
this.maxRetries = 3;  // æ”¹ç‚ºå…¶ä»–æ¬¡æ•¸
```

## ğŸ“± PIXIV å°ˆå±¬ç‰¹æ€§

### è³‡æ–™å¤¾çµæ§‹
```
pixiv/
â”œâ”€â”€ ä½œè€…1/
â”‚   â”œâ”€â”€ 001.jpg
â”‚   â”œâ”€â”€ 002.jpg
â”‚   â””â”€â”€ 003.jpg
â”œâ”€â”€ ä½œè€…2/
â”‚   â”œâ”€â”€ 001.png
â”‚   â””â”€â”€ 002.png
â””â”€â”€ ä½œå“é›†/
    â”œâ”€â”€ image1.jpg
    â””â”€â”€ image2.jpg
```

### é¡¯ç¤ºæ–¹å¼
- ğŸ“· **åœ–ç¤º**ï¼šè¡¨ç¤º PIXIV ä½œå“
- **æ•¸å­—**ï¼šé¡¯ç¤ºåœ–ç‰‡å¼µæ•¸ï¼ˆä¸æ˜¯ç« ç¯€æ•¸ï¼‰
- **åç¨±**ï¼šä½¿ç”¨è³‡æ–™å¤¾åç¨±ä½œç‚ºä½œå“åç¨±

### é»æ“Šè¡Œç‚º
- é»æ“Šè³‡æ–™å¤¾ â†’ ç›´æ¥é€²å…¥é–±è®€å™¨ï¼ˆä¸éœ€è¦é¸æ“‡ç« ç¯€ï¼‰
- åœ–ç‰‡ä¾åºè¼‰å…¥é¡¯ç¤º
- æ²’æœ‰ä¸Šä¸€è©±/ä¸‹ä¸€è©±ï¼ˆå› ç‚ºæ²’æœ‰ç« ç¯€æ¦‚å¿µï¼‰

## ğŸ§ª æ¸¬è©¦å»ºè­°

### 1. æ¸¬è©¦åˆ—è¡¨è¼‰å…¥
```
1. è¨ªå• http://localhost:5000/pixiv
2. ç¢ºèªåªé¡¯ç¤º 6 å€‹è³‡æ–™å¤¾
3. æ»¾å‹•åˆ°åº•éƒ¨
4. ç¢ºèªè‡ªå‹•è¼‰å…¥æ›´å¤šè³‡æ–™å¤¾
5. æª¢æŸ¥é¡¯ç¤º "ğŸ“· X å¼µåœ–ç‰‡"
```

### 2. æ¸¬è©¦é€²å…¥é–±è®€å™¨
```
1. é»æ“Šä»»æ„ PIXIV è³‡æ–™å¤¾
2. è§€å¯Ÿåœ–ç‰‡æ˜¯å¦ä¾åºè¼‰å…¥
3. ç¢ºèªæ¯å¼µåœ–ç‰‡è¼‰å…¥å®Œæˆç«‹å³é¡¯ç¤º
4. ä¸éœ€è¦æ»¾å‹•å³å¯çœ‹åˆ°æ‰€æœ‰åœ–ç‰‡
```

### 3. æ¸¬è©¦éŒ¯èª¤è™•ç†
```
1. æ¸¬è©¦ä¸å­˜åœ¨çš„è³‡æ–™å¤¾
2. æ¸¬è©¦ç©ºè³‡æ–™å¤¾
3. æ¸¬è©¦æå£çš„åœ–ç‰‡
4. ç¢ºèªæœ‰å‹å¥½çš„éŒ¯èª¤æç¤º
```

## ğŸ“ æ³¨æ„äº‹é …

1. **è³‡æ–™å¤¾åç¨±**ï¼šæ”¯æŒä¸­æ–‡å’Œç‰¹æ®Šå­—ç¬¦
2. **åœ–ç‰‡æ ¼å¼**ï¼šæ”¯æŒ `.jpg`, `.jpeg`, `.png`, `.gif`, `.webp`, `.bmp`, `.tiff`
3. **æª”æ¡ˆå¤§å°**ï¼šå»ºè­°å–®å€‹åœ–ç‰‡ < 10MB
4. **è³‡æ–™å¤¾æ•¸é‡**ï¼šç„¡é™åˆ¶ï¼Œä½†å»ºè­°åˆç†çµ„ç¹”
5. **ç¶²è·¯é€Ÿåº¦**ï¼šè¼ƒæ…¢ç¶²è·¯æœƒå¢åŠ æ¯å¼µåœ–ç‰‡çš„è¼‰å…¥æ™‚é–“

## ğŸ‰ ç¾åœ¨å·²å®Œæˆ

âœ… PIXIV åˆ—è¡¨åˆå§‹åªè¼‰å…¥ 6 å€‹è³‡æ–™å¤¾  
âœ… æ»¾è¼ªæ²å‹•è‡ªå‹•è¼‰å…¥æ›´å¤š  
âœ… é¡¯ç¤ºåœ–ç‰‡å¼µæ•¸è€Œä¸è¼‰å…¥åœ–ç‰‡  
âœ… é–±è®€å™¨é †åºè¼‰å…¥åœ–ç‰‡  
âœ… æ¯å¼µè¼‰å…¥å®Œæˆç«‹å³é¡¯ç¤º  
âœ… é¿å… timeout å•é¡Œ  
âœ… è‡ªå‹•é‡è©¦æ©Ÿåˆ¶  
âœ… å‹å¥½çš„éŒ¯èª¤æç¤º  

**PIXIV åŠŸèƒ½å·²å…¨é¢å„ªåŒ–å®Œæˆï¼** ğŸ¨
